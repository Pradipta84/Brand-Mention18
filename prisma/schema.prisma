// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

enum Channel {
  TWITTER
  REDDIT
  NEWS
  BLOG
  YOUTUBE
  FORUM
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum UpdateType {
  PRICING
  CAMPAIGN
  RELEASE
  PARTNERSHIP
  FEATURE
  ANNOUNCEMENT
  OTHER
}

enum QueryChannel {
  EMAIL
  TWITTER
  REDDIT
  CHAT
  FORUM
  SUPPORT_TICKET
  OTHER
}

enum QueryTagType {
  QUESTION
  REQUEST
  COMPLAINT
  FEEDBACK
  BUG_REPORT
  FEATURE_REQUEST
  BILLING
  TECHNICAL
  GENERAL
}

enum QueryPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum QueryStatus {
  NEW
  ASSIGNED
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
}

enum DocumentType {
  PDF
  DOCX
  DOC
  TXT
  MARKDOWN
  HTML
  IMAGE
  SPREADSHEET
  PRESENTATION
  VIDEO
  AUDIO
  OTHER
}

enum DocumentCategoryType {
  TOPIC
  PROJECT
  TEAM
  DEPARTMENT
  GENERAL
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      String   @default("analyst")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  alerts    Alert[]
  assignedQueries QueryAssignment[]
  queryHistory    QueryHistory[]
}

model Source {
  id        Int       @id @default(autoincrement())
  name      String
  channel   Channel
  url       String?
  createdAt DateTime  @default(now())
  mentions  Mention[]

  @@unique([name, channel])
}

model Topic {
  id        Int            @id @default(autoincrement())
  label     String         @unique
  createdAt DateTime       @default(now())
  mentions  MentionTopic[]
}

model Mention {
  id          String         @id @default(cuid())
  sourceId    Int
  source      Source         @relation(fields: [sourceId], references: [id])
  author      String
  handle      String?
  body        String
  permalink   String         @unique
  sentiment   Sentiment
  reach       Int            @default(0)
  publishedAt DateTime
  spike       Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  topics      MentionTopic[]
  alerts      Alert[]
}

model MentionTopic {
  mentionId String
  topicId   Int

  mention Mention @relation(fields: [mentionId], references: [id])
  topic   Topic   @relation(fields: [topicId], references: [id])

  @@id([mentionId, topicId])
}

model Alert {
  id              String        @id @default(cuid())
  title           String         @unique
  description     String
  severity        AlertSeverity
  createdAt       DateTime      @default(now())
  resolvedAt      DateTime?
  mentionId       String?
  mention         Mention?      @relation(fields: [mentionId], references: [id])
  competitorUpdateId String?
  competitorUpdate CompetitorUpdate? @relation(fields: [competitorUpdateId], references: [id])
  ownerId         String?
  owner           User?         @relation(fields: [ownerId], references: [id])
}

model Competitor {
  id        String            @id @default(cuid())
  name      String            @unique
  website   String?
  industry  String?
  notes     String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  updates   CompetitorUpdate[]
}

model CompetitorUpdate {
  id            String      @id @default(cuid())
  competitorId  String
  competitor    Competitor  @relation(fields: [competitorId], references: [id], onDelete: Cascade)
  type          UpdateType
  title         String
  description   String
  sourceUrl     String?
  sourceChannel Channel
  publishedAt   DateTime
  impact        AlertSeverity @default(MEDIUM)
  detectedAt    DateTime    @default(now())
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  alerts        Alert[]
  
  @@index([competitorId])
  @@index([type])
  @@index([publishedAt])
}

model QueryTag {
  id        Int            @id @default(autoincrement())
  label     String         @unique
  type      QueryTagType
  createdAt DateTime       @default(now())
  queries   QueryTagRelation[]
}

model Query {
  id              String            @id @default(cuid())
  channel         QueryChannel
  sourceId        String?          // External ID from source system
  authorName      String
  authorEmail     String?
  authorHandle    String?
  subject         String?
  body            String
  priority        QueryPriority    @default(MEDIUM)
  status          QueryStatus      @default(NEW)
  sourceUrl       String?
  receivedAt      DateTime         @default(now())
  firstResponseAt DateTime?
  resolvedAt      DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  tags            QueryTagRelation[]
  assignments     QueryAssignment[]
  history         QueryHistory[]
  
  @@index([status])
  @@index([priority])
  @@index([channel])
  @@index([receivedAt])
  @@index([sourceId])
}

model QueryTagRelation {
  queryId String
  tagId   Int

  query Query   @relation(fields: [queryId], references: [id], onDelete: Cascade)
  tag   QueryTag @relation(fields: [tagId], references: [id])

  @@id([queryId, tagId])
}

model QueryAssignment {
  id        String   @id @default(cuid())
  queryId   String
  query     Query    @relation(fields: [queryId], references: [id], onDelete: Cascade)
  assigneeId String
  assignee  User     @relation(fields: [assigneeId], references: [id])
  assignedAt DateTime @default(now())
  notes     String?
  
  @@index([queryId])
  @@index([assigneeId])
}

model QueryHistory {
  id        String      @id @default(cuid())
  queryId   String
  query     Query       @relation(fields: [queryId], references: [id], onDelete: Cascade)
  userId    String?
  user      User?       @relation(fields: [userId], references: [id])
  action    String      // e.g., "status_changed", "assigned", "priority_updated", "note_added"
  oldValue  String?
  newValue  String?
  notes     String?
  createdAt DateTime    @default(now())
  
  @@index([queryId])
  @@index([createdAt])
}

model DocumentCategory {
  id        Int            @id @default(autoincrement())
  name      String         @unique
  type      DocumentCategoryType
  createdAt DateTime       @default(now())
  documents DocumentCategoryRelation[]
}

model Document {
  id          String                    @id @default(cuid())
  title       String
  description String?
  content     String?                   // Full text content for search
  fileType    DocumentType
  fileUrl     String?                   // URL or path to file
  fileSize    Int?                      // Size in bytes
  mimeType    String?
  author      String?
  team        String?                   // Team that owns/created this
  project     String?                   // Project this belongs to
  tags        String[]                  // Array of tags for quick filtering
  indexedAt   DateTime                  @default(now())
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  categories  DocumentCategoryRelation[]
  
  @@index([title])
  @@index([team])
  @@index([project])
  @@index([fileType])
  @@index([indexedAt])
}

model DocumentCategoryRelation {
  documentId String
  categoryId Int

  document Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)
  category DocumentCategory @relation(fields: [categoryId], references: [id])

  @@id([documentId, categoryId])
}
